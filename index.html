<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>טיימר עם חישוב ממוצע ללא שינה</title>
<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; padding:24px; text-align:center; }
  .card { background:#fff; padding:20px; border-radius:14px; margin:0 auto; max-width:420px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
  h1 { margin:0 0 10px; font-size:22px; }
  .timer { font-size:56px; margin:8px 0; }
  .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  button { cursor:pointer; padding:10px 16px; border:none; border-radius:10px; font-size:16px; }
  #startBtn { background:#2f7d32; color:white; }
  #addSleepBtn { background:#ff9800; color:white; }
  .stat { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px; margin-top:12px; font-size:14px; }
  .muted { color:#888; }
  label { font-size:1em; margin-left:8px; }
  input[type="time"] { padding:5px; font-size:0.95em; }
  .stat2 {
  background: #f9f9fb;
  border: 1px solid #d3d3e7;
  border-radius: 10px;
  padding: 22px 18px 16px 18px;
  box-shadow: 0 2px 8px rgba(90,100,120,0.06);
  max-width: 400px;
  direction: rtl;
  font-family: 'Heebo', Arial, sans-serif;
  margin: 38px auto 0 auto; /* רווח למעלה ויישור לאמצע */
  display: flex;
  flex-direction: column;
  align-items: center;
}

.stat2 > div:first-child {
  font-size: 1.12em;
  color: #272752;
  margin-bottom: 10px;
  font-weight: 600;
  text-align: center;
}

.row2 {
  display: flex;
  align-items: center;
  gap: 14px;
  flex-wrap: wrap;
  justify-content: center;
}

.row2 label {
  font-size: 1em;
  color: #38387a;
  display: flex;
  align-items: center;
  gap: 4px;
}

.row2 input[type="time"] {
  border: 1px solid #b8b8d1;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 1em;
  background: #fff;
  color: #2e2e47;
  outline: none;
  transition: border 0.2s;
}

.row2 input[type="time"]:focus {
  border-color: #6c63ff;
}

#addSleepBtn {
  background: linear-gradient(92deg, #6c63ff 20%, #8f7cff 100%);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 6px 14px;
  font-size: 1em;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s, box-shadow 0.2s;
  box-shadow: 0 1px 4px rgba(80,80,120,0.07);
}

#addSleepBtn:hover {
  background: linear-gradient(92deg, #534bda 20%, #7a6be3 100%);
}

.muted2 {
  color: #75759b;
  font-size: 0.97em;
  margin-top: 7px;
  text-align: center;
}
</style>
</head>
<body>
<div class="card">
  <h1>טיימר 30 דק׳ + 5 דק׳ בכל לחיצה</h1>
  <div id="timer" class="timer">30:00</div>
  <div id="status" class="muted">מוכן להתחיל</div>

  <div class="row" style="margin-top:10px;">
    <button id="startBtn">התחל טיימר</button>
  </div>

  <div class="stat">
    <div><strong>מספר לחיצות:</strong> <span id="pressCount">0</span></div>
    <div><strong>אורך הטיימר הבא:</strong> <span id="nextLength">30 דקות</span></div>
  </div>

  <div class="stat">
    <div><strong>הממוצע שלך (ללא שינה):</strong></div>
    <div id="avgText" class="muted">—</div>
  </div>

  <div class="stat2">
    <div><strong>הוספת זמן שינה להסרה מהממוצע</strong></div>
    <div class="row2" style="margin-top:8px;">
      <label>נרדמתי: <input type="time" id="sleepStart" value="23:30"></label>
      <label>התעוררתי: <input type="time" id="sleepEnd" value="07:30"></label>
      <button id="addSleepBtn">הוסף שינה</button>
    </div>
    <div id="sleepRemovedInfo" class="muted2" style="margin-top:6px;">סה״כ שינה שהוסרה: 0 דקות</div>
  </div>
</div>

<script>
(() => {
  const BASE_MINUTES = 95;
  const INCREMENT = 5;
  const LS_KEY = 'mySimpleTimer';

  const timerEl = document.getElementById('timer');
  const statusEl = document.getElementById('status');
  const startBtn = document.getElementById('startBtn');
  const pressCountEl = document.getElementById('pressCount');
  const nextLengthEl = document.getElementById('nextLength');
  const avgTextEl = document.getElementById('avgText');
  const sleepStartInput = document.getElementById('sleepStart');
  const sleepEndInput = document.getElementById('sleepEnd');
  const addSleepBtn = document.getElementById('addSleepBtn');
  const sleepRemovedInfo = document.getElementById('sleepRemovedInfo');

  const defaultState = () => ({
    pressCount: 0,
    firstPressTs: null,
    targetTs: null,
    totalSleepRemovedMin: 0
  });

  const loadState = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : defaultState();
    } catch { return defaultState(); }
  };

  const saveState = () => {
    try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch {}
  };

  let state = loadState();
  let running = false;
  let tickInterval = null;

  function mmss(ms) {
    const total = Math.max(0, Math.ceil(ms / 1000));
    const m = Math.floor(total / 60);
    const s = total % 60;
    return `${m}:${String(s).padStart(2, '0')}`;
  }

  function formatMinutes(mins) {
    if (!isFinite(mins) || mins <= 0) return "—";
    const h = Math.floor(mins / 60);
    const m = Math.round(mins % 60);
    return h > 0 ? `${h} ש׳ ${String(m).padStart(2,"0")} דק׳` : `${m} דק׳`;
  }

  function parseHHMMtoMinutes(hhmm) {
    const [h, m] = hhmm.split(':').map(Number);
    return h * 60 + m;
  }

  function calcSleepDurationMin(startHHMM, endHHMM) {
    let start = parseHHMMtoMinutes(startHHMM);
    let end = parseHHMMtoMinutes(endHHMM);
    if (end < start) end += 1440; // חוצה חצות
    return end - start;
  }

  function nextTimerMinutes() {
    return BASE_MINUTES + INCREMENT * Math.max(0, state.pressCount);
  }

  function updateUI() {
    pressCountEl.textContent = state.pressCount;
    nextLengthEl.textContent = `${nextTimerMinutes()} דקות`;
    sleepRemovedInfo.textContent = `סה״כ שינה שהוסרה: ${state.totalSleepRemovedMin} דקות`;
    updateAverage();
  }

  function updateAverage() {
  if (!state.firstPressTs || state.pressCount < 2) {
    avgTextEl.textContent = '—';
    return;
  }
  const elapsedMin = (Date.now() - state.firstPressTs) / 60000;
  const adjustedMin = Math.max(0, elapsedMin - state.totalSleepRemovedMin);
  const intervals = state.pressCount - 1;
  const avg = adjustedMin / intervals;
  avgTextEl.textContent = formatMinutes(avg);
}

  function stopTimer() {
    running = false;
    clearInterval(tickInterval);
    tickInterval = null;
    state.targetTs = null;
    saveState();
    startBtn.disabled = false;
    timerEl.textContent = '00:00';
    statusEl.textContent = 'הטיימר הסתיים';
  }

  function startTimer() {
    if (running) return;
    const nowTs = Date.now();
    const minutes = nextTimerMinutes();

    if (!state.firstPressTs) state.firstPressTs = nowTs;
    state.pressCount += 1;
    state.targetTs = nowTs + minutes * 60 * 1000;
    saveState();

    running = true;
    startBtn.disabled = true;
    timerEl.textContent = mmss(state.targetTs - Date.now());
    statusEl.textContent = `טיימר רץ: ${minutes} דקות`;
    updateUI();

    tickInterval = setInterval(() => {
      const left = state.targetTs - Date.now();
      if (left <= 0) stopTimer();
      else timerEl.textContent = mmss(left);
      updateAverage();
    }, 200);
  }

  startBtn.addEventListener('click', startTimer);

  addSleepBtn.addEventListener('click', () => {
    const start = sleepStartInput.value || "23:30";
    const end = sleepEndInput.value || "07:30";
    const dur = calcSleepDurationMin(start, end);
    state.totalSleepRemovedMin += dur;
    saveState();
    updateUI();
  });

  // אתחול
  if (state.targetTs && state.targetTs > Date.now()) {
    running = true;
    startBtn.disabled = true;
    statusEl.textContent = 'טיימר רץ';
    tickInterval = setInterval(() => {
      const left = state.targetTs - Date.now();
      if (left <= 0) stopTimer();
      else timerEl.textContent = mmss(left);
      updateAverage();
    }, 200);
  } else {
    timerEl.textContent = mmss(BASE_MINUTES * 60 * 1000);
    statusEl.textContent = 'מוכן להתחיל';
  }
  updateUI();
})();
</script>
</body>
</html>
